<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>The Qur'an</title>
<style type="text/css">
* { font-family: Verdana; }
h1 {
  padding: 5px;
  background-color: #CCDDEE;
  border-bottom: 2px solid #399;
}
h1 a { text-decoration: none; color: #237;}
h1 a:hover { color: #469; }
h2 { cursor: pointer; }
h2:hover { color: #309; }
.hidden { display: none }
#list p { margin: 0px; padding: 0px; }
h2 { margin-left: 5px; font-size: 1em; }
/* Highlighted matches */
#text em {
  font-style: normal;
  background-color: #FF6;
  border-bottom: 1px solid #DD5;
}
/* Verse */
.v { margin: 5px 30px;}
/* References */
.r {
  font-family: Arial;
  margin: 0 0 0 15px;
  font-weight: bold;
  font-size: 0.8em;
}
.author {
  font-weight: bold;
  color: #692213;
}
/*author small*/
.as {
  color: #777;
  font-family: Arial;
  margin: 0 0 0 15px;
  font-size: 0.8em;
}
.notloaded { color: #999; }
</style>
<script type="text/javascript">
{%Quran.js%}
</script>
<script type="text/javascript">
{%Query.js%}
</script>
<script type="text/javascript">
{%ReferenceParser.js%}
</script>
<script type="text/javascript">
// var g_Authors = [
//   {name:"Yusuf Ali"},
//   {name:"Rashad Khalifa"},
//   {name:"Edip Yüksel"}
// ];
var g_Authors = {%QuranObjects%}
/**
  Author: Aziz Köksal
  License: GPL2
*/
function onHeaderClick(header)
{
  var divTag = header.nextSibling;
  if (divTag.className == "")
    divTag.className = "hidden";
  else
    divTag.className = "";
}

function getActiveAuthors()
{
  var div = document.getElementById("list");
  var nodes = div.childNodes;
  var authors = [];
  for(var i=0; i < nodes.length; ++i)
  {
    var cbox = nodes[i].childNodes[0];
    if (cbox.checked) {
      var index = /(\d+)$/.exec(cbox.id)[1];
      authors.push(g_Authors[index]);
    }
  }
  return authors;
}

function show(refsStr)
{
  var html = "<div>";
  var authors = getActiveAuthors();
  var refs = parseReferences(refsStr);
  if (authors.length == 0 || !(refs instanceof Array) || refs.length == 0)
    return;

  var interleave = document.getElementById("interleave");

  if (interleave.checked && authors.length > 1)
  {
    // We take the chapter titles and basmalah from the author
    // selected in the chapterListFromAuthor list.
    var fromAuthor = document.getElementById("chapterListFromAuthor");
    var author = g_Authors[parseInt(fromAuthor.value)];
    for(var i=0; i < refs.length; ++i)
    {
      var aref = refs[i];
      var cindices = aref.getChapterIndices();
      for(var j=0; j < cindices.length; ++j)
      {
        var cidx = cindices[j];
        var cidxStr = ""+(cidx+1);
        var vindices = aref.getVerseIndices(cidx);
        html += "<h2 onclick='onHeaderClick(this)'>"+cidxStr+". "+author.titles[cidx]+'</h2><div class="hidden">';
        if (cidx != 0 && cidx != 8) // Don't add Basmalah for chapter 1 and 9
          html += "<p>"+author.verses[0]+"</p>";
        for(var k=0; k < vindices.length; ++k)
        {
          var vidx = vindices[k];
          html += '<p class="r">'+cidxStr+":"+(vidx+1)+"</p>";
          for(var l=0; l < authors.length; ++l)
          {
            html += '<p class="as">'+authors[l].name+'</p><p class="v">'+ authors[l].chapters[cidx][vidx] + "</p>";
          }
        }
        html += "</div>";
      }
    }
  }
  else
  {
    for(var i=0; i < authors.length; ++i)
    {
      var author = authors[i];
      html += '<p class="author">'+author.name+":</p>";
      for(var j=0; j < refs.length; ++j)
      {
        var aref = refs[j];
        var cindices = aref.getChapterIndices();
        for(var k=0; k < cindices.length; ++k)
        {
          var cidx = cindices[k];
          var cidxStr = ""+(cidx+1);
          var chapter = author.chapters[cidx];
          var vindices = aref.getVerseIndices(cidx);
          html += "<h2 onclick='onHeaderClick(this)'>"+cidxStr+". "+author.titles[cidx]+'</h2><div class="hidden">';
          if (cidx != 0 && cidx != 8) // Don't add Basmalah for chapter 1 and 9
            html += "<p>"+author.verses[0]+"</p>";
          for(var l=0; l < vindices.length; ++l)
          {
            var vidx = vindices[l];
            html += '<p class="r">'+cidxStr+":"+(vidx+1)+"</p>";
            html += '<p class="v">'+ chapter[vidx] + "</p>";
          }
          html += "</div>";
        }
      }
    }
  }
  html += "</div>";

  var text = document.getElementById("text");
  text.innerHTML = html;

  // Show chapters expanded if html is not too long.
  if (html.length < 100000)
  {
    var divs = text.getElementsByTagName("div");
    for(var i=0; i < divs.length; ++i)
    {
      divs[i].className = "";
    }
  }
}

function search(query)
{
  var queries = parseQuery(query);

  var html = "<div>";
  var authors = getActiveAuthors();

  var refsString;
  if (document.getElementById("restrict").checked)
    refsString = document.getElementById("refs").value;
  else
    refsString = "1-114"; // Search all chapters
  var refs = parseReferences(refsString);

  if (authors.length == 0 || !(refs instanceof Array) || refs.length == 0)
    return;

  var predicate = document.getElementById("matchany").checked ? findAny2 : findAll2;

  for(var i=0; i < authors.length; ++i)
  {
    var author = authors[i];
    var totalNrOfMatches = 0;
    var htmlauthor = "";
    for(var j=0; j < refs.length; ++j)
    {
      var aref = refs[j];
      var cindices = aref.getChapterIndices();
      for(var k=0; k < cindices.length; ++k)
      {
        var cidx = cindices[k];
        var cidxStr = ""+(cidx+1);
        var chapter = author.chapters[cidx];
        var vindices = aref.getVerseIndices(cidx);
        var htmlfound = "";
        for(var l=0; l < vindices.length; ++l)
        {
          var vidx = vindices[l];
          var matchIndices = [];
          if (predicate(queries, chapter[vidx], matchIndices))
          {
            htmlfound += '<p class="r">'+cidxStr+":"+(vidx+1)+"</p>" +
                         '<p class="v">'+ highlightMatches(chapter[vidx], matchIndices) + "</p>";
            ++totalNrOfMatches;
          }
        }
        if (htmlfound.length)
        {
          htmlauthor += "<h2 onclick='onHeaderClick(this)'>"+cidxStr+". "+author.titles[cidx]+'</h2><div class="hidden">' +
                        htmlfound + "</div>";
        }
      }
    }
    if (htmlauthor.length)
    {
      html += "<p>Found "+totalNrOfMatches+" match"+(totalNrOfMatches==1?"":"es")+':</p><p class="author">'+author.name+":</p>" + htmlauthor;
    }
  }

  html += "</div>";

  var text = document.getElementById("text");
  text.innerHTML = html;

  // Show chapters expanded if html is not too long.
  if (html.length < 100000)
  {
    var divs = text.getElementsByTagName("div");
    for(var i=0; i < divs.length; ++i)
    {
      divs[i].className = "";
    }
  }
}

/*
function getNode(refs)
{
  var html = document.createElement("div");
  var authors = getActiveAuthors();
  if (authors.length == 0)
    return null;
  var authorsNodes = [];
  for(var i=0; i < authors.length; ++i)
  {
    var node = document.createElement("span");
    node.innerHTML = authors[i].name;
    authorsNodes.push(node);
  }

  for(var i=0; i < refs.length; ++i)
  {
    var aref = refs[i];
    var cindices = aref.getChapterIndices();
    for(var j=0; j < cindices.length; ++j)
    {
      var cidx = cindices[j];
      var vindices = aref.getVerseIndices(cidx);
      for(var k=0; k < vindices.length; ++k)
      {
        var vidx = vindices[k];
        var node = document.createElement("p");
        node.innerHTML = (cidx+1) + ":" + (vidx+1);
        html.appendChild(node);
        node = document.createElement("div");
        html.appendChild(node);
        for(var l=0; l < authors.length; ++l)
        {
          node.appendChild(authorsNodes[l].cloneNode(true));
          var verse = document.createElement("blockquote");
          verse.innerHTML = "<p>"+authors[l].chapters[cidx][vidx]+"</p>";
          node.appendChild(verse);
        }
      }
    }
  }
  return html;
}
*/

/**
  History class for keeping track of commands typed in a text box.
*/
function History()
{
  this.current = 0;
  this.array = [];
  this.getCurrent = function()
  {
    return this.array[this.current];
  }
  this.add = function(item)
  {
    // Don't add item if it matches the last item in the array.
    if (this.array.length > 1 &&
        this.array.length-1 == this.current &&
        this.getCurrent() == item)
        return;

    this.array.push( item );
    this.current = this.array.length -1;
  }
  this.prev = function()
  {
    if (this.current > 0)
      this.current--;
    else if (this.array.length == 0)
      return "";
    return this.getCurrent();
  }
  this.next = function()
  {
    if (this.current < this.array.length -1)
      this.current++;
    else if (this.array.length == 0)
      return "";
    return this.getCurrent();
  }
}

function changeAuthor(select)
{
  populateChapterList(parseInt(select.value));
//   select.width = document.getElementById("chapterList").width;
}

function selectChapter(select)
{
  show(select.value);
}

function parseReferences(str)
{
  var parser = new ReferenceListParser(str);
//   var tokens;
  var refs = null;
  try
  {
//     tokens = parser.getTokens();
    refs = parser.parseReferences();
  }
  catch (e)
  {
    if (!(e instanceof ParseError))
      throw e;
    var errorMsg = "";
    if (e.pos == str.length)
      errorMsg = str + '<u> </u>';
    else
      errorMsg = str.slice(0, e.pos) + "<u>" + str[e.pos] + "</u>" + str.slice(e.pos+1);
    errorMsg = "<pre>"+errorMsg+"</pre>"+"Error in reference list: " + e.msg;

    var errDiv = document.getElementById("error");
    errDiv.innerHTML = errorMsg;
    setTimeout("removeErrorMsg()", 6000);
  }
//   alert(tokens);
  return refs;
}

function removeErrorMsg()
{
  var errDiv = document.getElementById("error");
  errDiv.innerHTML = "";
}

function loadVerses(checkbox)
{
  var parent = checkbox.parentNode;
  if (parent.className != "notloaded")
    return; // Author is already loaded

  var div = document.getElementById("verses");

  // Extract index from id.
  var index = /(\d+)$/.exec(checkbox.id)[1];
  // Get the comment node with the verses of the requested author.
  var verses = div.childNodes[index];

  // Add loading-message
  parent.removeAttribute("class");
  parent.appendChild(document.createTextNode(" loading..."));

  // Verses are separated by '\n'. Splitting the contents of the
  // comment node will return an array of 6236 strings.
  var versesArray = verses.data.split('\n');

  verses.data = ""; // Once the data is loaded, we can empty the comment node.

  // Finally set the authors verses.
  g_Authors[index].setVerses( versesArray );

  // Remove loading-message
  parent.removeChild(parent.lastChild);
}

function init()
{
/*
  var chapters = document.getElementsByTagName("h2");
  for (var i=0; i < chapters.length; i++)
  {
    chapters[i].onclick = onMouseClick;
  }
*/
  // onkeydown event handler for text inputs.
  function onKeyDown(e)
  {
    if(!e) e = window.event;
    if (e.keyCode == 13)
    {
      if (this.id == "refs")
        show(this.value);
      else
        search(this.value);
      this.history.add(this.value);
    }
    else if(e.keyCode == 38)
      this.value = this.history.prev();
    else if(e.keyCode == 40)
      this.value = this.history.next();
  }
  // Set event handler and new History instance for references input.
  var input = document.getElementById("refs");
  input.history = new History();
  input.onkeydown = onKeyDown;
  // Ditto for search input.
  input = document.getElementById("search");
  input.history = new History();
  input.onkeydown = onKeyDown;

  // Set authors list
  var div = document.getElementById("list");
  var list = document.getElementById("chapterListFromAuthor");
  var option;
  for (var i=0; i < g_Authors.length; ++i)
  {
    option = document.createElement("option");
    option.appendChild(document.createTextNode(g_Authors[i].name));
    option.value = i;
    list.appendChild(option);
    div.innerHTML += '<p class="notloaded"><input onchange="loadVerses(this)" type="checkbox" id="author'+i+'">' + g_Authors[i].name + "</input></p>";
  }
  list.style.width = "auto"; // Required by IE
  populateChapterList(0);
}

/// Empties the contents of a node and returns it.
function empty(node)
{
  while(node.firstChild)
    node.removeChild( node.firstChild );
  return node
}

function populateChapterList(authorId)
{
  var titles = g_Authors[authorId].titles;
  var list = document.getElementById("chapterList");
  empty(list);
  var option;
  for (var i=0; i < titles.length; ++i)
  {
    option = document.createElement("option");
    option.appendChild(document.createTextNode((i+1)+". "+titles[i]));
    option.value = i+1;
    list.appendChild(option);
  }

  list.style.width = "auto"; // Required by IE
}

function visibilityOfChapters(value)
{
  var span_collapse = document.getElementById("collapse");
  var span_expand = document.getElementById("expand");
  if (value == "hidden")
  {
    span_collapse.className = "hidden";
    span_expand.className = "";
  }
  else
  {
    span_expand.className = "hidden";
    span_collapse.className = "";
  }

  var divs = document.getElementsByTagName("div");
  for (var i = 0; i < divs.length; i++)
  {
    divs[i].className = value;
  }
}

</script>
</head>
<body onload="init()" style="margin:0;padding:0;">
<h1><a href="http://code.google.com/p/openquran/">openquran</a><br><span style="font-size: 0.4em;">Version 0.22</span></h1>
<div style="padding:0 5px 5px 5px;">
<div style="float:right">
<p><select id="chapterListFromAuthor" onchange="changeAuthor(this)"></select></p>
<p><select id="chapterList" multiple="true" size="20" onchange="selectChapter(this)"></select></p>
</div>
<p>Available authors:</p>
<div id="list"></div>
<table>
<tr><td>
References: <input type="text" id="refs" /> <button onclick="show(document.getElementById('refs').value)">Show</button><br/>
<input type="checkbox" id="interleave">interleave verses</input><br/>
</td>
<td>
<input onkeypress="if(event.keyCode == 13)return false;" type="text" id="search" /> <button onclick="search(document.getElementById('search').value)">Search</button><br/>
<input type="checkbox" id="matchany">match any</input>
<input type="checkbox" id="highlight">highlight matches</input>
<input type="checkbox" id="restrict">restrict to references</input>
</td></tr>
</table>
<div id="error" onclick="removeErrorMsg()"></div>
<!--
<p>Click on a chapter header to expand.<br>
<span id="expand"><a href='javascript:visibilityOfChapters("")'>Expand all chapters</a> (don't click on slow computers)</span>
<span id="collapse" class="hidden"><a href='javascript:visibilityOfChapters("hidden")'>Collapse all chapters</a></span></p>-->
<div id="text"></div>
</div>
<div id="verses" style="display:none">{%Verses%}</div>
</body>
</html>